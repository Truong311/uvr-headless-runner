# UVR Headless Runner - PyPI è‡ªåŠ¨å‘å¸ƒå·¥ä½œæµ
# 
# è§¦å‘æ¡ä»¶ï¼š
#   - æŽ¨é€ç‰ˆæœ¬æ ‡ç­¾ (v1.0.0, v1.2.3 ç­‰)
#   - æ‰‹åŠ¨è§¦å‘ (workflow_dispatch)
#
# ä½¿ç”¨å‰é…ç½®ï¼š
#   1. PyPI: Account Settings â†’ API tokens â†’ Add API token
#   2. GitHub: Settings â†’ Secrets â†’ Actions â†’ New repository secret
#      - PYPI_API_TOKEN: PyPI API Token (ä»¥ pypi- å¼€å¤´)

name: Publish to PyPI

on:
  push:
    tags:
      - 'v*'  # åŒ¹é… v1.0.0, v1.2.3 ç­‰æ ‡ç­¾
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  publish:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # è®¾ç½® Python çŽ¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      # å®‰è£…æž„å»ºå·¥å…·
      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine
      
      # ä»Žæ ‡ç­¾æå–ç‰ˆæœ¬å·å¹¶éªŒè¯ä¸Ž pyproject.toml ä¸€è‡´
      - name: Verify version consistency
        run: |
          if [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
            TAG_VERSION=${GITHUB_REF#refs/tags/v}
            TOML_VERSION=$(python -c "
          import re
          with open('pyproject.toml') as f:
              match = re.search(r'^version\s*=\s*\"(.+?)\"', f.read(), re.MULTILINE)
              print(match.group(1) if match else 'UNKNOWN')
          ")
            echo "Tag version:  $TAG_VERSION"
            echo "TOML version: $TOML_VERSION"
            if [ "$TAG_VERSION" != "$TOML_VERSION" ]; then
              echo "::error::Version mismatch! Tag=$TAG_VERSION, pyproject.toml=$TOML_VERSION"
              exit 1
            fi
            echo "âœ… Version consistency verified: $TAG_VERSION"
          fi
      
      # æž„å»º sdist å’Œ wheel
      - name: Build package
        run: python -m build
      
      # æ£€æŸ¥æž„å»ºäº§ç‰©
      - name: Check package
        run: twine check dist/*
      
      # å‘å¸ƒåˆ° PyPI
      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: twine upload dist/*
      
      # è¾“å‡ºå‘å¸ƒä¿¡æ¯
      - name: Publish summary
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "## ðŸ“¦ PyPI Package Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Package" >> $GITHUB_STEP_SUMMARY
          echo "- **Name**: uvr-headless-runner" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **PyPI**: https://pypi.org/project/uvr-headless-runner/$VERSION/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Install" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "pip install uvr-headless-runner==$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
